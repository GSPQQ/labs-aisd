import tkinter as tk
import random

# --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –î–∏–∑–∞–π–Ω–∞ (–û—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏) ---
COLOR_BG = "#F0F0F0"
COLOR_SHIP = "#3CB371"
COLOR_EMPTY = "#ADD8E6"
COLOR_HIT = "#FF4500"
COLOR_MISS = "#4682B4"
COLOR_DISABLED_SHIP = "#808080"
FONT_STATUS = ("Helvetica", 16, "bold")
FONT_LABEL = ("Helvetica", 12, "bold")

SIZE = 10

def place_ships():
    board_cells, ships = set(), []
    for size in [4, 3, 3, 2, 2, 2, 1, 1, 1, 1]:
        placed = False
        for _ in range(200):
            h = random.choice([True, False])
            x = random.randint(0, SIZE - (size if h else 1))
            y = random.randint(0, SIZE - (size if not h else 1))
            cells = {(x + (i if h else 0), y + (i if not h else 0)) for i in range(size)}
            
            if all((cx + dx, cy + dy) not in board_cells 
                   for cx, cy in cells 
                   for dx in (-1, 0, 1) 
                   for dy in (-1, 0, 1)):
                
                ships.append(cells)
                board_cells |= cells
                placed = True
                break
        if not placed: 
            # –ó–¥–µ—Å—å –º—ã –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ —Ç–æ, —á—Ç–æ –∑–∞ 200 –ø–æ–ø—ã—Ç–æ–∫ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—Å—è
            pass
            
    return ships

class Board:
    def __init__(self):
        self.ships, self.shots = place_ships(), set()

    def shoot(self, pos):
        if pos in self.shots: return None
        self.shots.add(pos)
        
        for s in self.ships:
            if pos in s: 
                # –ù–∞–π–¥–µ–Ω–æ –ø–æ–ø–∞–¥–∞–Ω–∏–µ
                if s.issubset(self.shots):
                    return "sunk", s # –í–æ–∑–≤—Ä–∞—â–∞–µ–º "sunk" –∏ —Å–∞–º –∫–æ—Ä–∞–±–ª—å
                else:
                    return "hit", None # –í–æ–∑–≤—Ä–∞—â–∞–µ–º "hit"
        return "miss", None # –í–æ–∑–≤—Ä–∞—â–∞–µ–º "miss"

    def all_sunk(self):
        return all(s.issubset(self.shots) for s in self.ships)

class AI:
    def __init__(self):
        self.board = Board()
        self.targets, self.used = [], set()

    def shoot(self):
        if self.targets: 
            # –û—á–∏—â–∞–µ–º —Ü–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã
            while self.targets and self.targets[-1] in self.used:
                self.targets.pop()
            if self.targets:
                return self.targets.pop()

        allp = [(x, y) for x in range(SIZE) for y in range(SIZE) if (x, y) not in self.used]
        return random.choice(allp) if allp else (0, 0)

    # –ú–µ—Ç–æ–¥ feedback —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Ç–æ–ø–ª–µ–Ω–Ω–æ–º –∫–æ—Ä–∞–±–ª–µ, –µ—Å–ª–∏ —Ç–∞–∫–æ–≤–æ–π –µ—Å—Ç—å
    def feedback(self, pos, res, sunk_ship_cells=None):
        self.used.add(pos)
        
        if res == "hit":
            x, y = pos
            for dx, dy in [(1, 0), (-1, 0), (0, 1), (0, -1)]:
                nx, ny = x + dx, y + dy
                if 0 <= nx < SIZE and 0 <= ny < SIZE and (nx, ny) not in self.used:
                    # –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–ª—å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —Ü–µ–ª–µ–π –∏ –Ω–µ –±—ã–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞
                    if (nx, ny) not in self.targets:
                         self.targets.append((nx, ny))
                         
        elif res == "sunk":
            self.targets.clear()
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è AI: –æ—Ç–º–µ—á–∞—Ç—å –æ—Ä–µ–æ–ª –ø—Ä–æ–º–∞—Ö–∞
            if sunk_ship_cells:
                # –û—Ç–º–µ—á–∞–µ–º –∫–ª–µ—Ç–∫–∏ –≤–æ–∫—Ä—É–≥ –ø–æ—Ç–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –∫–æ—Ä–∞–±–ª—è –∫–∞–∫ "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ" (–ø—Ä–æ–º–∞—Ö–∏)
                for cx, cy in sunk_ship_cells:
                    for dx in (-1, 0, 1):
                        for dy in (-1, 0, 1):
                            px, py = cx + dx, cy + dy
                            if 0 <= px < SIZE and 0 <= py < SIZE and (px, py) not in sunk_ship_cells:
                                self.used.add((px, py))
                                # –£–±–∏—Ä–∞–µ–º –∏–∑ —Ü–µ–ª–µ–π, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Ç–∞–º –±—ã–ª–∞ –∫–ª–µ—Ç–∫–∞ –æ—Ä–µ–æ–ª–∞
                                if (px, py) in self.targets:
                                    self.targets.remove((px, py)) 


class Game:
    def __init__(self, root):
        self.root = root
        self.player, self.ai = Board(), AI()
        self.root.title("–ú–æ—Ä—Å–∫–æ–π –±–æ–π")
        self.root.config(bg=COLOR_BG)
        self.game_active = True
        self.setup_ui()
        self.update()

    # (–ú–µ—Ç–æ–¥ setup_ui –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    def setup_ui(self):
        f = tk.Frame(self.root, bg=COLOR_BG, padx=10, pady=10)
        f.pack()
        self.status = tk.Label(f, text="–í–∞—à —Ö–æ–¥!", font=FONT_STATUS, bg=COLOR_BG)
        self.status.grid(row=0, column=0, columnspan=22, pady=(0, 10))
        tk.Label(f, text="–ú–æ–π —Ñ–ª–æ—Ç", font=FONT_LABEL, bg=COLOR_BG).grid(row=1, column=0, columnspan=10)
        tk.Label(f, text="–§–ª–æ—Ç –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞", font=FONT_LABEL, bg=COLOR_BG).grid(row=1, column=12, columnspan=10)
        f.grid_columnconfigure(10, minsize=50)
        self.p_btns, self.e_btns = [], []
        for y in range(SIZE):
            row_p, row_e = [], []
            for x in range(SIZE):
                b_p = tk.Button(f, width=2, height=1, bg=COLOR_EMPTY, state="disabled", relief=tk.RAISED)
                b_p.grid(row=y + 2, column=x, padx=1, pady=1)
                row_p.append(b_p)
                b_e = tk.Button(f, width=2, height=1, bg=COLOR_EMPTY, relief=tk.RAISED,
                                command=lambda x=x, y=y: self.shot(x, y))
                b_e.grid(row=y + 2, column=x + 12, padx=1, pady=1)
                row_e.append(b_e)
            self.p_btns.append(row_p)
            self.e_btns.append(row_e)
        tk.Button(f, text="–ù–æ–≤–∞—è –∏–≥—Ä–∞", command=self.restart, font=FONT_LABEL, bg="#FFA07A").grid(
            row=SIZE + 2, column=0, columnspan=22, pady=(15, 0), ipadx=20)
        
    # --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
    def mark_miss_around_ship(self, board_instance, sunk_ship_cells):
        """–û—Ç–º–µ—á–∞–µ—Ç –æ—Ä–µ–æ–ª –≤–æ–∫—Ä—É–≥ –ø–æ—Ç–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –∫–æ—Ä–∞–±–ª—è –∫–∞–∫ –ø—Ä–æ–º–∞—Ö."""
        for cx, cy in sunk_ship_cells:
            # –û–±—Ö–æ–¥ —Å–æ—Å–µ–¥–Ω–∏—Ö –∫–ª–µ—Ç–æ–∫ (–≤–∫–ª—é—á–∞—è —É–≥–ª—ã)
            for dx in (-1, 0, 1):
                for dy in (-1, 0, 1):
                    px, py = cx + dx, cy + dy
                    pos = (px, py)
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –∏ —Ç–æ–≥–æ, —á—Ç–æ –∫–ª–µ—Ç–∫–∞ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∫–æ—Ä–∞–±–ª—é
                    if 0 <= px < SIZE and 0 <= py < SIZE and pos not in sunk_ship_cells:
                        board_instance.shots.add(pos)

    def update(self):
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –ò–≥—Ä–æ–∫–∞
        for y in range(SIZE):
            for x in range(SIZE):
                p = self.p_btns[y][x]
                pos = (x, y)
                is_ship = any(pos in s for s in self.player.ships)
                is_shot = pos in self.player.shots

                if is_shot:
                    # –ü–æ–ø–∞–ª –∏–ª–∏ –ø—Ä–æ–º–∞—Ö
                    p.config(bg=COLOR_HIT if is_ship else COLOR_MISS, text="X" if is_ship else "‚Ä¢", fg="white" if is_ship else "black")
                elif is_ship:
                    # –°–≤–æ–π –∫–æ—Ä–∞–±–ª—å (–Ω–µ —Å—Ç—Ä–µ–ª—è–ª–∏)
                    p.config(bg=COLOR_SHIP, text="", fg="black")
                else:
                    # –ü—É—Å—Ç–∞—è –≤–æ–¥–∞
                    p.config(bg=COLOR_EMPTY, text="", fg="black")
                    
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
        for y in range(SIZE):
            for x in range(SIZE):
                e = self.e_btns[y][x]
                pos = (x, y)
                is_shot = pos in self.ai.board.shots
                is_ship = any(pos in s for s in self.ai.board.ships)
                
                if is_shot:
                    # –í—ã—Å—Ç—Ä–µ–ª –±—ã–ª
                    e.config(state="disabled", text="X" if is_ship else "‚Ä¢", 
                             bg=COLOR_HIT if is_ship else COLOR_MISS,
                             fg="white" if is_ship else "black")
                else:
                    # –í—ã—Å—Ç—Ä–µ–ª–∞ –Ω–µ –±—ã–ª–æ
                    e.config(state="normal" if self.game_active else "disabled", text="", bg=COLOR_EMPTY)

    def shot(self, x, y):
        if not self.game_active:
            return

        # 1. –•–æ–¥ –ò–≥—Ä–æ–∫–∞
        res_p, ship_p = self.ai.board.shoot((x, y)) # res_p: "hit", "sunk", "miss"
        if res_p is None: 
            return # –£–∂–µ —Å—Ç—Ä–µ–ª—è–ª–∏
            
        if res_p == "sunk":
            # –û—Ç–º–µ—á–∞–µ–º –æ—Ä–µ–æ–ª –ø—Ä–æ–º–∞—Ö–∞ –≤–æ–∫—Ä—É–≥ –ø–æ—Ç–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –∫–æ—Ä–∞–±–ª—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
            self.mark_miss_around_ship(self.ai.board, ship_p)

        self.update() 

        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã
        if self.ai.board.all_sunk():
            self.status.config(text="üéâ –ü–û–ë–ï–î–ê! –í—Å–µ –∫–æ—Ä–∞–±–ª–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –ø–æ—Ç–æ–ø–ª–µ–Ω—ã!", fg="green")
            self.game_active = False
            self.update()
            return
            
        # 3. –•–æ–¥ AI (—Å—Ç—Ä–µ–ª—è–µ—Ç –¥–æ –ø—Ä–æ–º–∞—Ö–∞)
        self.status.config(text="–•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...")
        self.root.update()
        
        while True:
            if not self.game_active: break
            
            ai_pos = self.ai.shoot()
            res_ai, ship_ai = self.player.shoot(ai_pos)

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ AI
            if res_ai == "sunk":
                ai_res = "sunk"
                self.mark_miss_around_ship(self.player, ship_ai) # –û—Ç–º–µ—á–∞–µ–º –æ—Ä–µ–æ–ª –ø—Ä–æ–º–∞—Ö–∞ –≤–æ–∫—Ä—É–≥ —Å–≤–æ–µ–≥–æ –∫–æ—Ä–∞–±–ª—è
                self.ai.feedback(ai_pos, ai_res, ship_ai) # –ü–µ—Ä–µ–¥–∞–µ–º AI –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Ç–æ–ø–ª–µ–Ω–Ω–æ–º –∫–æ—Ä–∞–±–ª–µ
            elif res_ai == "hit":
                ai_res = "hit"
                self.ai.feedback(ai_pos, ai_res)
            else: # res_ai == "miss"
                ai_res = "miss"
                self.ai.feedback(ai_pos, ai_res)

            self.update()
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–∞–∂–µ–Ω–∏—è
            if self.player.all_sunk():
                self.status.config(text="üò¢ –ü–û–†–ê–ñ–ï–ù–ò–ï! –í—Å–µ –≤–∞—à–∏ –∫–æ—Ä–∞–±–ª–∏ –ø–æ—Ç–æ–ø–ª–µ–Ω—ã!", fg="red")
                self.game_active = False
                self.update()
                return

            if res_ai == "miss" or res_ai is None:
                # –ï—Å–ª–∏ AI –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è, —Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –æ–±—Ä–∞—Ç–Ω–æ –∏–≥—Ä–æ–∫—É
                break
                
            # –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ —Ö–æ–¥–∞ AI
            self.root.after(200) 
            
        self.status.config(text="–í–∞—à —Ö–æ–¥!", fg="black")

    def restart(self):
        self.player, self.ai = Board(), AI()
        self.game_active = True
        self.status.config(text="–í–∞—à —Ö–æ–¥!", fg="black")
        self.update()

root = tk.Tk()
Game(root)
root.mainloop()
